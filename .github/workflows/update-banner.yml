name: Update Banner

on:
  # 1. PER CRON-JOB.ORG (EXTERN)
  repository_dispatch:
    types: [trigger_update]
  
  # 2. PER EXECUCI√ì MANUAL (GITHUB UI)
  workflow_dispatch:
  
  # 3. PER CRON INTERN (GITHUB) - DESACTIVAT PER EVITAR CONFLICTES
  # schedule:
  #   - cron: '15 * * * *'  # (COMENTAT)
  #   - cron: '45 * * * *'  # (COMENTAT)

jobs:
  update-banner:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      # 0. IDENTIFICA ORIGEN (OPCIONAL, PER LOGS)
      - name: Identificar origen de l'execuci√≥
        run: |
          echo "üîç ORIGEN DE L'EXECUCI√ì: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "üöÄ DISPARAT PER: CRON-JOB.ORG"
            echo "üìå Event type: ${{ github.event.action || 'trigger_update' }}"
            echo "üë§ Client: ${{ github.event.client_payload.trigger || 'Desconegut' }}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "üñ±Ô∏è DISPARAT PER: Manual (GitHub UI)"
            echo "üë§ Usuari: ${{ github.actor }}"
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            echo "‚è∞ DISPARAT PER: Programaci√≥ interna (GitHub Actions)"
          fi
      
      # 1. DESCARREGA REPOSITORI
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. CONFIGURA PYTHON
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 3. INSTAL¬∑LA DEPEND√àNCIES
      - name: Install dependencies
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            echo "‚ö†Ô∏è  requirements.txt no trobat, instal¬∑lant depend√®ncies b√†siques..."
            pip install requests beautifulsoup4
          fi

      # 4. OBT√â DADES METEOROL√íGIQUES
      - name: Get weather data
        run: python meteo_scraper.py

      # 5. GENERA BANNER
      - name: Generate banner
        run: python generate_banner.py

      # 6. ACTUALITZA INDEX.HTML
      - name: Update only index.html
        run: |
          cp banner_output.html index.html
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add index.html
          
          if git diff --staged --quiet; then
            echo "‚úÖ No hi ha canvis a index.html (dades ja actualitzades)"
          else
            # Missatge diferent segons l'origen
            if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
              COMMIT_MSG="üîÑ Actualitzaci√≥ autom√†tica (cron-job.org) $(date -u +'%H:%M UTC')"
            elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              COMMIT_MSG="üñ±Ô∏è Actualitzaci√≥ manual (${{ github.actor }}) $(date -u +'%H:%M UTC')"
            else
              COMMIT_MSG="‚è∞ Actualitzaci√≥ programada $(date -u +'%H:%M UTC')"
            fi
            
            git commit -m "$COMMIT_MSG"
            git push
            echo "‚úÖ index.html actualitzat i pujat"
          fi
      
      # 7. MISSATGE FINAL (OPCIONAL)
      - name: Confirmaci√≥ final
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "‚úÖ EXECUCI√ì COMPLETADA"
          echo "========================================"
          echo "Origen: ${{ github.event_name }}"
          echo "Data: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "SHA: ${{ github.sha }}"
          echo "========================================"
